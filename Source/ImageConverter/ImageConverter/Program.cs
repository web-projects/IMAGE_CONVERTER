using ImageConverter.Engine;
using ImageConverter.Helpers;
using Microsoft.Extensions.Configuration;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;

namespace ImageConverter
{
    class Program
    {
        static readonly string[] imagePayload = new string[]
        {
            // INGENICO CustId: 1117607, Transaction ID: 097-0000084421
            "89504E470D0A1A0A0000000D494844520000003F0000004B0103000000FD22CD4B000000017352474200AECE1CE90000000467414D410000B18F0BFC610500000006504C5445000000FFFFFFA5D99FDD000000097048597300000EC300000EC301C76FA864000000F04944415428CFADD2414EC3301005D0EC58E608DC841C855EA4726FC0117A0C1608A5272827A0E98E154DD9342DAEFDF9DF9E6911DD12C9D25B78FE583369C06F1100611F7A64E1091539602838C1303946C7D2110C9989A5FCE4981C2CE2356270740615F1E426C1101DAA4E82AA0BD8B2822DAF88174C8ED1300D8EDE3006C34E553DB111DE887761DF022F028782E7022C9AB60298DD1B1EB777151D8E0599590F8E8D90D866E7380891380A0758A070163E6FC0E7E05B78FD8D9233E7593BD43473186705260E233A3E84482CCB0623D76AF8AAAB8C682BD2AABE67C89D81C105FD0DC25F6885FF816BB27E0EE41FE2793241255B26A80000000049454E44AE426082",
            // VERIFONE CustId: 1117600, Transaction ID: 097-0000084582
            "89504E470D0A1A0A0000000D4948445200000320000001E008060000005D0709F5000000017352474200AECE1CE90000000467414D410000B18F0BFC6105000000097048597300000EC300000EC301C76FA86400000DC749444154785EEDD9EB921BB90D0650BFFF4B27A1BDBDE99125F58D179038A7AA7F243B96D800687FA8F90500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000057FCE7E1030000F0568B05E2DD6796070000486AC452601101008064222C0116110000585CC4D06F11010080C5CC10F22D21000030B9D97EBB30DB79010080FF993DC85B44000060122B05774B08000004B66260F7DB1000000868F5906E090100800032FD86C012027DB97300C00F19C341A6850B4671CF0080BF640F07C211B4B1DD2D770C00F89760F0873A405D960F00E02F82C14FA51E6A02CFBCDE23770A00F84D28F84C6DE09ED7BBE32E0100BF038150704C8DE09A7777C63D0280E484816BD40B8E957B62F90000FE220CDCA36EF0D9B7FBE1EE00406282C033EA073F953B61F90000DE1204EA5047F8E3CC5D705F00202921A02EF5243BCB0700F09110D086BA925199FBB3B3EF8E00405242403B6A4B2657E6DDDD0080A48480F6D4980CAECEB97B0100090900FDA835AB2AB36DF900000E09007DA9372BBA3BD7EE030024E31FFF31D49D559459B67C0000A70900E3A83DB37B32C3E61F00121200C6527F66F6747ECD3F0024E31FFF18F481D99499B57C000097F8C73F16FD60163566D5BC03404202403C7A4274960F00E0160120267D21AA329BB5E6D39C034032FEF18F4D7F88A6E64C9A6F0048C63FFE73D02722287368F900001E1100E6A04F8CD66206CD350024E31FFFB9E817A3583E00802A0480B9E817BD9599B37C000055080073D2377A69396BE61800121200E6B45ADFCAFB1C3DF4D7B2EE7A0A00090900739BB57FE5DCAFCF19577E96675AD75A1F01202921606E33F56F0BB435CE5CEB7378AF756DF50E00921202D630431F5B9DB17CAE39AEA7573DF50C00121200D611B9973D03AD997EA657FDF40900921202D612B19F23CE64AEEFE95537FD0180A48480F544EBE9C8F398EFF34AAD7AD54B5F00203141604D51FA1AE11CE50CE6FCBB9EF5D10B00484C10585784DE469B2FF3FE5EEFBAE80300242608AC6D547FCBF7469D2D33FF7F23FAA4FE00909820B0BE113D9E61AECCBED90000061006D6D7BBC733CD54D6F92FEF3DE2DDB3D61B00F887309047AF5ECF3853E5CC99EEC2A877CD546300E00381208FD6BD2E9F3FFB3C65B80FA3DE31436D01800302413EAD7ABED22CAD7A2FCA7B8D7AB7556B0A005C2414E4D3A2E72BCED16AEF34F27DFC3D0300FC2614E455B3F72BCFD12AEF36FA3DFC5D0300FC2614E455ABF7196668E6772C671F7DFE0C3302009C2014E456A3FF996668C6778D70667FCF0000FF120C783A03D9666896F72DE78C70D66CF301007C2118503C9983AC3314FDBDA39CCFDF3100C00FC2019B3BB3907D7EA2BE7F9473F9FB0500F88B80C0E6EA2C989D3F22D5A19C25C279A29C030008464060EFCA3C989D9F22D4234A4FCC0600F091A0C0AB3333616EDE1B5997283D311B00C057C202AF8E66C2CC7CD7BB3EE5FBA2F4C46C00005F090B7CF26936CCCC39BDEA14A91F660300382430F0C9BBD9302FD7B4AC57F9EC28FD887416002030818123FB19312FF7B408E7917A612E0080D304078E6C3362569EAB55C348BD301700C025C20347CA8C98937A9ED4325A2FCC05007089F0C019E6A4BE3B8B44A43EDC393F008000C1A16D46CC4A1B67EB1AA9FE660100B84D90E09BFD7C9895764A6D3FD5F7DB7FEB2DD25900800909127CF33A1FE6A5BDA8352FE7D07F00E03181826FA286E1D56D613F4ABDF51D00A846B0E0934FB36166DADB6A3CBAD6E5FBF51B00A84AB8E09D6F736166DA7AAD6FF9DFBD6B3EE23B018004040CDE399A0B73D3C651E83FFAEF35F4F80E0020314183576766C2DCD477A5A6E5676BF7A0C5670200FC45E060EFCA3C989D7AEED6B2FCB9FD73C7933F0B007089D0C1DED579303FCFD50EFFDBE75D790000BA113ED8BB3A0FE6E719F50300D21180D8DC9905F3734FA99BDA01002909411477E7C0FC5CA76600405A8210C593393043D7A81700909A30C4D3193043E7943AA91500909E40945BADFE9BA3EFD40700E01F82516E1690F6D40600604738CAAB66EFCDD1DF4A4DD40500E085809453EDBE9BA39FD40300E00D2129A7167D374B7F943AA80500C00782524E169036D40000E080C0944FAB9E679F25770900E004A1299796FDCE3A4BE5BDDD2300809304A75C2C2075B93F000017095079B4EE75B659727700006E10A272E8D1E72CB354DED3BD0100B849905A5FAF1E679825F70500E021816A7D3D7BBCEA3C95F7725700002A10AAD6D6BBBF2BCE933B0200509170B5AE11BD5D6D9EDC0F0080CA04AC755940EE2BEFE16E0000342064AD69545F579827770200A021616B3D237B3AFB3CB90F00008D095C6B19DDCF59E7A99CDB5D0000E840E85A8B05E43A770000A023E16B1D117A39D33C95B39A7F00800184B0F945E9E12CB364E601000612C6E616A97F33CC92790700184C209B5B94FE459FA3723EB30E0010805036AF48BD8B3C47661C002010E16C4ED1FA16758ECC3700403002DA7C22F62CE24264B601000212D2E612B55F91CE65A601008213D8E66101F9AC9CC12C03004C40689B43E43E8D3E9B1906009888F0169FE5E333F30B003019012EB6E8FDB973BEF2673E3D675DFD7900000211E4E28ADE9BB3E7DB1686A39F3FF373479F01004070025D4C33F4E56851D89E3BDEFDB9BB9F05004030825D3C33F4E4D39250EBECDBE7D4FC4C00000210EE6299A11FFB336E0B428B73CF500B00006E10F4E288DE8B6DD9D81E0000B84C908C216A1F5E170EF30200C06342E578D17AB05F3AF6CC0A00008F09956345AAFFA7C56363560000A842B01C6774EDB7A5E3E81C66040080AA04CCFE46D57C5B38AE7CBFF90000A03A21B3AF9EF5DE168EBBDF693600006842D0ECA3479DB785A3C677990B00009A1136DB6B59E35A4BC79E990000A02981B39D16B5DD968E569F0D0000CD099EF5D5AE69ABA563CF1C0000D04D8F809B498D5A6E3DE9D517FD0700A03B21F4B9BB35DC968DEDE96DC47702008020FAD0D9FA6D8BC6F68C34FAFB0100484E20BDE7A86EDBB211ADBEFA0D00C07011837274AFF5DA6A18B99651CF0500405291C373245B9DF6CF0C6639270000C9CC14AA5BDB6AF1FACC66C633030090CCCC81FBAAFDBBEE9F57EFFEBF19CC7A6E000092DA87F29943F8A7E7AC2B3F1BC58C670600801FF6E17D7BA27877B6F23C55E3334698F5DC0000F0D53EEC6F4F6DEFBEE3F569A5E567B732E3990100E0B6FD6250E31965E4773F31EBB90100202DCB070000D08D05040000E8C2F2010000746301010000BAB07C000000DDCC18E42D1F00003021BFFD000000BAF1DB0F0000A00BCB070000D0CD6C61DEF201000093F2DB0F0000A01BBFFD000000BAB07C000000DD58400000802E2C1F0000403733057ACB0700004CCCF2010000746301010000BA9925D45B3E0000600133047BCB0700002CC0F201000074133DDC5B3E000060219103BEE50300001662F9000000BA891AF22D1F0000B0A08841DFF20100008B8A16F62D1F0000B0B04881DFF20100008B8B12FA2D1F0000904084E06FF9000080244686FFF2DD960F00004864D40260F1000080847A2F027EEB010000C9F55A082C1E000040F3C5C06F3D0000801F5A2C08160F0000E0AD9A8B82C503000038F47469B078000000976C4BC4994562FFB3677E1E0000E0A3D705E3F50100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E0B75FBFFE0B9FF8E149977CA9F30000000049454E44AE426082",
            // VERIFONE CustId: 1117600, Transaction ID: 097-0000087899
            "89504E470D0A1A0A0000000D494844520000003F0000004B0806000000C7EC5F08000000017352474200AECE1CE90000000467414D410000B18F0BFC6105000000097048597300000EC300000EC301C76FA8640000002A49444154785EEDC13101000000C2A0F54F6D0D0F200000000000000000000000000000000000007ED4004A1F0001AE56958F0000000049454E44AE426082",
            // VERIFONE CustId: 1117600, Transaction ID: 097-0000091176
            "89504E470D0A1A0A0000000D4948445200000356000000F00103000000393F6746000000017352474200AECE1CE90000000467414D410000B18F0BFC610500000006504C5445000000FFFFFFA5D99FDD000000097048597300000EC300000EC301C76FA864000003444944415478DAEDDAB18EE230100660100525F555BE37E161EE41B2A72D2879045E654F1494BC4256296883688264652E63301953612EBF75C51F8965232DF9348E673C0E3B936287A7458B162D5AB468D1A2458B162D5AB468D1A2458B162D5AB468D1A2458B162D5AB468BD7A2CCB59BEA055FF2A672D2EC5AC76754DCEFF00AD99746B4BCF7156B712BF32E71F3F70565B89ECCC4797579CB51F5E660CEB0A686D457A637DCA1966F56EF8F3CA9E36304B9D2E393DC12C75CC1D6A458E304BEF8EA91B4D322927B69AFBEB7E6C924939B175B8BFEE874B26E5C496968CF10EF9B59D94135B218AF10E75C9A49CD80A51B8C7E959725339C3D228CC1D6A243795332C8DA21FEFD0299928135B1A851F4F0FA13E822C8DC2948D63762A67581AC539B1D6304BA368ACD557304BA7FBC95A5E505698EE476B75302BA4B2997987EC54CEB0F4C7583686E16C6056183133F3BEB353F9754B53CBCEBCB6DAC22C8DCB2E227EE5609697A74564B6C659D5D32292DBCDE7E457957436FA49588DD24E34E907AFD99BCCD76BD4FC69C13ACB6F98F5354F17AC26EC5B30969FCDECE66B08D2E37AB6276C8BEC45A5FF69A7B943F6D8438AD56324BAC6202DE9170646EE53B4FC8E4F19B45E01ADA16C7495819156631BDF0BD6D2B2F158484E584B2FBDB5F01667EDC484B215E89C77D67292B43A135B4987A827C03D6CE86CA2A5A98CDBC3DE3AC4687582DCC3DE2E1DADB320F7B0B74B47EBE961C7D456E86C624A692A6F7056E86C624A0DF1F52B9C15862FA6D44EB25B801C2B0C5FBCBE13E0FEEB1652DC3D681A7F032D0D29A6AFBE6F705608298E5BF7C6D4C87D1E15D37778EF70FB945B48317D87F72FC159E1994DECE80FB6A59ADE4ACAC6513A07B4C2F08DA99C3F8499CFBE1EABE3FA9D6FF85EB7B444C5F4EAABDA212DADBA6DFC54F529484B876F7FFFBDF32BA4156E559C866DFE0307C97CE6D0C79B54CF056A89DD3908D4D2B2D14A194BAB6E53C8526753C8D2CEC615B28EF9FDFBDBD6EE9FA7E1EB96CBEFA9DFB574FCF6A5ACEAF6C55E096B281B9D2B640D9D4D2D85ACB37EFF5FC8BAE87F6F14B24E52AF0B59FDD22FA490254F0F60A1D6C75C8A59531CB468D1A2458B162D5AB468D1A2458B162D5AB468D1A2458B162D5AB468D1A2458BD67F6689FF0B52E365470FD59F990000000049454E44AE426082",
            "",
         };

        static void Main(string[] args)
        {
            Console.WriteLine($"\r\n==========================================================================================");
            Console.WriteLine($"{Assembly.GetEntryAssembly().GetName().Name} - Version {Assembly.GetEntryAssembly().GetName().Version}");
            Console.WriteLine($"==========================================================================================\r\n");

            IConfiguration configuration = ConfigurationLoad();

            IEnumerable<Tuple<string, string>> signatureList = LoadSignatureGroup(configuration);
            ProcessSignaturePayload(signatureList);

            // INGENICO IMAGE
            //byte[] imageBytes = ConversionHelper.HexToByteArray(imagePayload[0]);
            //byte[] imageBytes = ConversionHelper.HexToByteArray(imagePayload[imagePayload.Length - 2]);
            // VERIFONE IMAGE
            //byte[] imageBytes = ConversionHelper.HexToByteArray(imagePayload[3]);
            //if (imageConverter.ConvertByteArrayToImage(imageBytes))
            //{
            //    imageConverter.ImageDisplay();
            //}
        }

        static void ProcessSignaturePayload(IEnumerable<Tuple<string, string>> signatureList)
        {
            Console.WriteLine("IMAGE FROM BYTE ARRAY...");
            ImageConverterEngine imageConverter = new ImageConverterEngine();

            foreach (Tuple<string, string> item in signatureList)
            {
                try
                {
                    byte[] imageBytes = ConversionHelper.HexToByteArray(item.Item2);
                    {
                        if (imageConverter.ConvertByteArrayToImage(imageBytes, item.Item1))
                        {
                            imageConverter.ImageDisplay(item.Item1);
                        }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Exception processing signature payload=[{ex.Message}]");
                }
            }
        }

        static IConfiguration ConfigurationLoad()
        {
            // Get appsettings.json config.
            IConfiguration configuration = new ConfigurationBuilder()
                .AddJsonFile("appsettings.json", optional: true, reloadOnChange: true)
                .AddEnvironmentVariables()
                .Build();

            return configuration;
        }

        static IEnumerable<Tuple<string, string>> LoadSignatureGroup(IConfiguration configuration)
        {
            var signaturePayload = configuration.GetSection("ImagePayload")
                .GetChildren()
                .ToList()
                .Select(x => new
                {
                    FileName = x.GetValue<string>("Filename"),
                    ImageSignature = x.GetValue<string>("ImageSignature")
                });

            List<Tuple<string, string>> results = new List<Tuple<string, string>>();

            List<string> filenamesInPayload = new List<string>();
            List<string> signaturesInPayload = new List<string>();

            if (signaturePayload.Count() > 0)
            {
                int index = 0;
                filenamesInPayload.AddRange(from value in signaturePayload
                                            select signaturePayload.ElementAt(index++).FileName);
                index = 0;
                signaturesInPayload.AddRange(from value in signaturePayload
                                             select signaturePayload.ElementAt(index++).ImageSignature);

                foreach (Tuple<string, string> combinedOutput in filenamesInPayload
                    .Zip(signaturesInPayload, (vc, vv) => Tuple.Create(vc, vv)))
                {
                    results.Add(combinedOutput);
                }
            }

            return results;
        }
    }
}
